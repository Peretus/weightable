<% require "date" %>

<script src="Chart.js"></script>

<div class="row">
  <div class="lg-col-4">
    <strong>Name:</strong>
    <%= @user.name %>
    <% if @user.profile_pic_url %>
      <img class="profile-pic clearfix" src=<%= @user.profile_pic_url(:medium) %> />
    <% else %>
      <div class="no-image-wrapper">
        <%= form_for(@user) do |f| %>
          <% if @user.errors.any? %>
            <div id="error_explanation">
              <h2><%= pluralize(@user.errors.count, "error") %> prohibited this user from being saved:</h2>

              <ul>
              <% @user.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
              </ul>
            </div>
          <% end %>

          <div class="field">

            <%= f.label :profile_pic %><br>
            <%= f.file_field :profile_pic, :required => true %><br><br>

          </div>
          <div class="actions">
            <%= f.submit %>
          </div>
        <% end %>
      <% end %>
    </div>
  
 		<span><%= @user.weigh_ins.size %> Weigh-Ins |</span>     
    <span class="spacing"><%= @user.friends.size %> Fat Friends</span> <br><br>
  </div>
</div>
<div class="row">
  <div class="lg-col-6">
    <div class="progress-container">
      <span class="recent-weight">START: <%= @user.weigh_ins.last.weight %>lbs.</span>
      <div id="progressbar"></div>
      <span class="goal">FINISH: <%= @user.goal %>lbs.</span>
    </div>
    <%= link_to 'Edit', edit_user_path(@user) %> |
    <%= link_to 'Back', users_path %>
 </div>
</div>

<div class="row">
  <div class="lg-col-6">
    <canvas id="myChart" width="400" height="400"></canvas>

    <% if @user.weigh_ins.first.created_at + 24*60*60 > Time.now %>
      <%= button_to "Update Today's WeighIn", edit_user_weigh_in_path(@user, :id => @user.weigh_ins.last.id), method: :get%> 
    <% else %>
      <div id="createWeighIn" >
        <h1>Post a weigh-in</h1>
          <p>
            <%= form_for [@user, @weigh_in] do |f| %>
              <%= f.label :weight %>
              <%= f.text_field :weight %><br />

              <%= f.label :status%>
              <%= f.text_field :status %><br />

              <%= f.submit "Weigh In!" %>
            <% end %>
          </p>
      </div>
    <%end%>
  </div>

<!-- Displays user's BMI from users_controller and rounds to nearest two digit decimal place -->
<h1>Body Mass Index (BMI): <%= @bmi.round(2) %></h1>
<h1>Record Weight: <%= @record_weight %></h1>

  <div class="lg-col-6">  
  	<div class="panel">
      <h1>Your Weigh-Ins</h1>
      <% counter = 0 %>
      <% @user.weigh_ins.each do |weight| %>
        <% @weights.unshift(weight.weight) %>
  	    <% @goal.unshift(@user.goal) %>
  	    <% @dates.unshift((weight.created_at).strftime("%a")) %>
        <div class="panel-group" id="accordion">
          <div class="panel panel-default">
            <div class="panel-heading">
              <%= button_to "show WeighIn", user_weigh_in_path(@user, weight), method: :get, :class=>"pull-right" %>
              <h4 class="panel-title inline">
                <span class="name"><%= @user.name %></span>
                <span class="time">posted <%= time_ago_in_words(weight.created_at) %> ago</span>
              </h4>
              <span>Weigh-In:<%= weight.weight %>lbs</span>
              <span>Yeehaws!: <%= weight.wi_yeehaws.count %></span>
              <span>Message:<%= weight.status %></span>
              <a class="pull-right" data-toggle="collapse" data-parent="#accordion" href="#collapse<%= counter %>">Click for comments</a>

            </div>
          </div>
        </div>
        <div id="collapse<%= counter %>" class="panel-collapse collapse">
          <div class="panel-body">
            

            <% weight.comments[0..2].each do |comment| %>
            <div class="row">
              <div class="lg-col-2">
                <img class="push-left" src=<%= comment.user.profile_pic_url(:thumb) %> />
                by: <%= comment.user.name %> 
              </div>
              <div class="lg-col-10">  
                <%= comment.body %>
                Comment ID: <%= comment.id%>
                
              </div>
            </div>
            <% end %>
          </div>
        </div>
      <% counter+=1 %>
      <% end %>
    </div>
  </div>
</div>
	<script type="text/javascript">
  

  $(function() {
	options = {
		// set to line chart instead of curve
		//Boolean - If we want to override with a hard coded scale
		scaleOverride : true,
		
		//** Required if scaleOverride is true **
		//Number - The number of steps in a hard coded scale
		scaleSteps : 5,
		//Number - The value jump in the hard coded scale
		scaleStepWidth : <%= (((@user.weigh_ins.first.weight+5)-(@user.goal-15))/5) %>,
		//Number - The scale starting value
		scaleStartValue : <%= @user.goal-2%>,
		
		


	}

  	data = {
    labels :  <%=raw @dates.length > 7 ? @dates[-7,7] : @dates %>,
    datasets : [
      {
        fillColor : "rgba(0,240,0,0.3)",
        strokeColor : "rgba(255,93,0,.9)",
        pointColor : "rgba(51,51,51,1)",
        pointStrokeColor : "rgba(0,132,164,1)",
        data : <%= @weights.length > 7 ? @weights[-7,7] : @weights %>
      },
      {
        fillColor : "rgba(255,0,0,0.3)",
        strokeColor : "rgba(255,93,0,.9)",
        pointColor : "rgba(51,51,51,1)",
        pointStrokeColor : "rgba(0,132,164,1)",
        data : <%= @weights.length > 7 ? @goal[-7,7] : @goal %>
      }
    ]
  }

  myNewChart = new Chart($("#myChart").get(0).getContext("2d")).Line(data,options)
});</script>

<script>
$( "#progressbar" ).progressbar({
  value: <%=@progress%>
});
</script>
